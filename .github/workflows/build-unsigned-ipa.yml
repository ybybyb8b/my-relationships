name: Build iOS IPA for Sideloadly

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install Dependencies
        run: | 
          npm install
          npm install @capacitor/ios

      # å®‰è£…å›¾æ ‡ç”Ÿæˆå·¥å…·
      - name: Install Asset Generator
        run: npm install @capacitor/assets --save-dev

      - name: Build React App
        run: |
          npm run build
          ls -F dist/ || echo "Warning: dist folder missing!"

      - name: Generate iOS Platform
        run: |
          echo "æ­£åœ¨æ¸…ç†æ—§ç¯å¢ƒ..."
          rm -rf ios
          
          echo "æ­£åœ¨ç”Ÿæˆå…¨æ–° iOS å·¥ç¨‹..."
          npx cap add ios
          
          echo "æ­£åœ¨åŒæ­¥æ’ä»¶..."
          npx cap sync ios

      - name: Update CocoaPods
        run: |
          gem install cocoapods

      - name: Sync Capacitor
        run: |
          npx cap sync ios

      # âœ¨ æ–°å¢æ­¥éª¤ï¼šè‡ªåŠ¨ç”Ÿæˆ iOS å›¾æ ‡
      # å®ƒä¼šè¯»å–æ ¹ç›®å½•ä¸‹çš„ assets/icon.png
      - name: Generate App Icon
        run: |
          npx capacitor-assets generate --ios --iconBackgroundColor "#d8d3cd" --splashBackgroundColor "#d8d3cd"

      # ç¼–è¯‘ IPA
# === âš¡ï¸ æ ¸å¿ƒè¶…çº§æ­¥éª¤ï¼šä¸€æ°”å‘µæˆ âš¡ï¸ ===
      - name: Build, Sync and Compile IPA
        run: |
          set -e  # ä»»ä½•ä¸€æ­¥å‡ºé”™ç«‹åˆ»åœæ­¢ï¼Œä¸è®¸å‡è£…æˆåŠŸ

          echo "ğŸš€ Step 1: Building Web Assets..."
          npm run build
          # æ£€æŸ¥ dist æ˜¯å¦çœŸçš„ç”Ÿæˆäº†
          if [ ! -d "dist" ]; then
            echo "âŒ Error: 'dist' folder missing after build!"
            exit 1
          fi

          echo "ğŸ§¹ Step 2: Cleaning old iOS platform..."
          rm -rf ios

          echo "âœ¨ Step 3: Adding iOS platform..."
          npx cap add ios
          # æ£€æŸ¥ Podfile æ˜¯å¦çœŸçš„ç”Ÿæˆäº†ï¼ˆè¿™æ˜¯ä¹‹å‰æŠ¥é”™çš„æ ¹æºï¼‰
          if [ ! -f "ios/App/Podfile" ]; then
            echo "âŒ Error: Podfile was NOT created in ios/App/!"
            echo "ğŸ” Debugging ios directory:"
            ls -R ios || echo "ios directory not found"
            exit 1
          fi

          echo "ğŸ”„ Step 4: Syncing Plugins..."
          npx cap sync ios

          echo "ğŸ¨ Step 5: Generating Icons..."
          npx capacitor-assets generate --ios --iconBackgroundColor "#d8d3cd" --splashBackgroundColor "#d8d3cd"

          echo "ğŸ“¦ Step 6: Installing CocoaPods..."
          cd ios/App
          pod install --repo-update

          echo "ğŸ”¨ Step 7: Building Xcode Project..."
          xcodebuild build \
            -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY="" \
            -quiet

          echo "ğŸ“¦ Step 8: Packaging IPA..."
          mkdir -p Payload
          mv build/Build/Products/Release-iphoneos/App.app Payload/
          zip -r MyRelations.ipa Payload
          
          # éªŒè¯ IPA æ˜¯å¦ç”Ÿæˆ
          ls -lh MyRelations.ipa