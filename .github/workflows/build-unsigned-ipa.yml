name: Build iOS IPA for Sideloadly

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # Capacitor 8 éœ€è¦ Node 22+
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22

      - name: Install Dependencies
        run: npm install

      - name: Install Asset Generator
        run: npm install @capacitor/assets --save-dev

      # === âš¡ï¸ æ ¸å¿ƒæ„å»ºæ­¥éª¤ (é€‚é… Capacitor 8 SPM æ¨¡å¼) âš¡ï¸ ===
      - name: Build, Sync and Compile IPA
        run: |
          set -e

          echo "ğŸš€ Step 1: Building Web Assets..."
          npm run build
          if [ ! -d "dist" ]; then
            echo "âŒ Error: 'dist' folder missing!"
            exit 1
          fi

          echo "ğŸ”„ Step 24: Syncing Plugins..."
          npx cap sync ios

          echo "ğŸ¨ Step 3: Generating Icons..."
          npx capacitor-assets generate --ios --iconBackgroundColor "#d8d3cd" --splashBackgroundColor "#d8d3cd"

          echo "ğŸ”¨ Step 4: Building Xcode Project..."
          # âš ï¸ æ³¨æ„ï¼šCap 8 ä½¿ç”¨ SPMï¼Œæ‰€ä»¥è¿™é‡Œç”¨ -project App.xcodeproj è€Œä¸æ˜¯ -workspace
          # å¹¶ä¸”ä¸éœ€è¦ pod install
          
          cd ios/App
          xcodebuild build \
            -project App.xcodeproj \
            -scheme App \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY="" \
            -quiet

          echo "ğŸ“¦ Step 5: Packaging IPA..."
          mkdir -p Payload
          # è·¯å¾„å¾®è°ƒï¼šSPM æ„å»ºåçš„äº§ç‰©è·¯å¾„å¯èƒ½ç•¥æœ‰ä¸åŒï¼Œé€šå¸¸åœ¨è¿™ä¸ªä½ç½®
          mv build/Build/Products/Release-iphoneos/App.app Payload/
          zip -r MyRelations.ipa Payload
          
          ls -lh MyRelations.ipa

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: MyRelations-Unsigned
          path: ios/App/MyRelations.ipa
